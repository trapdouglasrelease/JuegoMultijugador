<!DOCTYPE html>
<html>
<head>
    <title>Juego Multijugador</title>
    <style>
        body { font-family: Arial, sans-serif; }
        canvas { 
            border: 1px solid black;
            display: block;
            margin-bottom: 10px;
        }
        #chatInput {
            padding: 8px;
            width: 384px;
            font-size: 16px;
        }
    </style>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="1000" height="560"></canvas>
        
        <!-- Chat: A√±ad√≠ un contenedor extra para mejor control -->
        <div id="chatBox">
            <div id="chatHistory"></div>
            <input type="text" id="chatInput" placeholder="Chatea con nosotros...">
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chatInput = document.getElementById('chatInput');
        let players = {};

        function drawPlayers() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            Object.values(players).forEach(player => {
                // Dibujar jugador
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, 10, 0, Math.PI * 2);
                ctx.fill();

                // Dibujar nombre
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, player.x, player.y - 15);

                // Dibujar mensajes (m√°ximo 2)
                player.messages?.forEach((msg, index) => {
                    ctx.fillStyle = '#333';
                    ctx.font = '10px Arial';
                    ctx.fillText(msg.text, player.x, player.y - 30 - (index * 15));
                });
            });
        }

        // Eventos del servidor
        socket.on('init', (data) => {
            players = { ...data.otherPlayers, [socket.id]: data.currentPlayer };
            drawPlayers();
        });

        socket.on('newPlayer', (newPlayer) => {
            players[newPlayer.id] = newPlayer;
            drawPlayers();
        });

        socket.on('playerMoved', (data) => {
            if (players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
                drawPlayers();
            }
        });

        socket.on('messageSent', (data) => {
            if (players[data.id]) {
                players[data.id].messages = data.messages;
                drawPlayers();
            }
        });

        socket.on('messageUpdate', (data) => {
            if (players[data.id]) {
                players[data.id].messages = data.messages;
                drawPlayers();
            }
        });

        socket.on('playerDisconnected', (id) => {
            delete players[id];
            drawPlayers();
        });

        // Movimiento con teclado
        document.addEventListener('keydown', (e) => {
            const speed = 20;
            const player = players[socket.id];
            if (!player) return;

            switch(e.key) {
                case 'w': player.y -= speed; break;
                case 's': player.y += speed; break;
                case 'a': player.x -= speed; break;
                case 'd': player.x += speed; break;
                default: return;
            }

            // Limitar al √°rea del canvas
            player.x = Math.max(10, Math.min(canvas.width - 10, player.x));
            player.y = Math.max(10, Math.min(canvas.height - 10, player.y));

            socket.emit('playerMove', { x: player.x, y: player.y });
            drawPlayers();
        });

        // --- AGREGA ESTO (nuevo control del chat) ---
        let isChatOpen = false;

        // 1. Abrir chat con Enter (global)
        document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !isChatOpen) {
        e.preventDefault();
        chatInput.focus();
        isChatOpen = true;
        }
        });

        // 2. Enviar o Cerrar chat (input abierto)
        chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
        if (chatInput.value.trim() !== '') {
            socket.emit('sendMessage', chatInput.value.trim());
            chatInput.value = '';
        } else {
            e.preventDefault();
            chatInput.blur();
            isChatOpen = false;
        }
        }
        });

        // 3. Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
        if (e.target !== chatInput && isChatOpen) {
        chatInput.blur();
        isChatOpen = false;
        }
        });

        socket.on('updateChatHistory', (messages) => {
            const chatHistoryDiv = document.getElementById('chatHistory');
            // Mantener orden cronol√≥gico: nuevos mensajes ABAJO
            chatHistoryDiv.innerHTML = messages.map(msg => 
                `<div><strong>${msg.playerName}:</strong> ${msg.text}</div>`
            ).reverse('').join(''); // ‚Üê Sin .reverse() ni orden inverso

            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // üëà ¬°Esto es clave!
        });
    </script>
</body>
</html>